#!/usr/bin/env bash
set -e

echo "[*] Updating system..."
dnf update -y
dnf install -y epel-release

########################################
# Install packages
########################################
echo "[*] Installing required packages..."
dnf install -y httpd php php-mysqlnd php-cli mariadb-server mariadb \
               gcc make unzip git curl policycoreutils-python-utils \
               setools-console

systemctl enable --now httpd
systemctl enable --now mariadb

########################################
# Disable SELinux enforcement (CTF friendly)
########################################
echo "[*] Setting SELinux to permissive..."
setenforce 0 || true
sed -i 's/^SELINUX=enforcing/SELINUX=permissive/' /etc/selinux/config

########################################
# Create CTF structure
########################################
BASE=/opt/ctf
mkdir -p $BASE/{crypto,stego,web,privesc,root,lateral}

########################################
# Weak user for privilege escalation
########################################
echo "[*] Creating weak user..."
useradd -m ctfplayer -s /bin/bash || true
echo "ctfplayer:weakpass123" | chpasswd

########################################
# SIMPLE LEVEL CHALLENGES
########################################

######## 1. CRYPTO (Easy)
mkdir -p $BASE/crypto/easy
echo "U2FsdGVkX1+uCRYPTO_CAESAR_SHIFT_13_FLAG_u==" > $BASE/crypto/easy/encrypted_message.txt
echo "FLAG{CRYPTO_SIMPLE_123}" > $BASE/crypto/easy/flag.txt

######## 2. SQL Injection Challenge
echo "[*] Setting up SQLi challenge..."

mkdir -p /var/www/html/sql-challenge

cat << 'EOF' > /var/www/html/sql-challenge/index.php
<?php
$conn = mysqli_connect("localhost", "root", "", "ctfweb");

$user = $_GET['user'] ?? '';
$query = "SELECT secret FROM users WHERE username = '$user'";
$result = mysqli_query($conn, $query);

echo "<h2>Login Lookup</h2>";
echo "Query: $query<br>";

if ($row = mysqli_fetch_assoc($result)) {
    echo "Secret: " . $row['secret'];
} else {
    echo "No user found!";
}
?>
EOF

systemctl restart mariadb

mysql -u root <<EOF
CREATE DATABASE IF NOT EXISTS ctfweb;
USE ctfweb;
CREATE TABLE IF NOT EXISTS users (
    id INT AUTO_INCREMENT PRIMARY KEY,
    username VARCHAR(50),
    secret VARCHAR(200)
);
INSERT INTO users (username, secret) VALUES ("admin", "FLAG{SQL_INJECTION_456}");
EOF

######## 3. XSS Challenge
echo "[*] Creating XSS challenge..."
mkdir -p /var/www/html/xss-challenge

cat << 'EOF' > /var/www/html/xss-challenge/index.php
<html>
<body>
<h2>XSS Comment Box</h2>
<form>
<input type="text" name="msg">
<input type="submit">
</form>
<p>Your message:</p>
<?= $_GET["msg"] ?? "" ?>
</body>
</html>
EOF

echo "FLAG{XSS_789}" > $BASE/web/xss_flag.txt

########################################
# MEDIUM LEVEL CHALLENGES
########################################

######## 4. Medium Crypto – Substitution
mkdir -p $BASE/crypto/medium
cat << 'EOF' > $BASE/crypto/medium/cipher.txt
Encrypted:
FUR QBRF GUR PNFG PNFGVAT?
Hint: Use frequency analysis / substitution cipher techniques.
EOF

echo "FLAG{CRYPTO_MEDIUM_777}" > $BASE/crypto/medium/flag.txt

######## 5. Stego Medium
mkdir -p $BASE/stego/medium
echo "Replace this with real stego image." > $BASE/stego/medium/README.txt
echo "FLAG{STEGO_MEDIUM_888}" > $BASE/stego/medium/hidden_flag.txt


######## 6. Lateral Movement — Weak User
echo "[*] Creating lateral user 'analyst'..."
useradd -m analyst -s /bin/bash || true
echo "analyst:password" | chpasswd
echo "FLAG{WEAK_HASH_555}" > /home/analyst/flag.txt
chmod 600 /home/analyst/flag.txt


########################################
# PRIVILEGE ESCALATION CHALLENGES
########################################

######## 7. Capability Exploit
echo "[*] Setting file capability challenge..."
mkdir -p $BASE/privesc/cap

cat << 'EOF' > $BASE/privesc/cap/debug
#!/bin/bash
echo "Debug run..."
cat /opt/ctf/privesc/cap/flag.txt
EOF

chmod +x $BASE/privesc/cap/debug
setcap cap_setuid+ep $BASE/privesc/cap/debug || true

echo "FLAG{CAPABILITY_666}" > $BASE/privesc/cap/flag.txt


######## 8. SUID Root Shell Simulation
echo "[*] Compiling SUID privesc binary..."
cat << 'EOF' > /opt/ctf/privesc/suid_prog.c
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
int main() {
    setuid(0);
    system("/bin/bash");
    return 0;
}
EOF

gcc /opt/ctf/privesc/suid_prog.c -o /opt/ctf/privesc/suid_prog
chmod 4755 /opt/ctf/privesc/suid_prog

echo "FLAG{SUID_MEDIUM_444}" > /opt/ctf/privesc/suid_flag.txt


######## 9. Final Boot-to-Root Flag
echo "FLAG{ROOT_MEDIUM_FINAL_000}" > /root/root_flag2.txt
chmod 600 /root/root_flag2.txt

########################################
# Restart Apache
########################################
systemctl restart httpd

echo "============================================"
echo " CTF SETUP COMPLETE — CentOS Stream 9"
echo "============================================"
echo " Access:"
echo "  SQLi: http://<IP>/sql-challenge"
echo "  XSS:  http://<IP>/xss-challenge"
echo ""
echo " Users:"
echo "   ctfplayer / weakpass123"
echo "   analyst   / password"
echo ""
echo " Root flags:"
echo "   /root/root_flag2.txt"
echo "============================================"
